# 标签提取功能使用指南 (v2.0)

## 功能概述

增强版vectors扩展现在拥有一个全新的、基于规则的标签提取系统。您不再需要编写复杂的命令，而是通过一个直观的UI来精确地从聊天消息中提取或排除特定内容进行向量化。

## 核心概念：规则 (Rules)

所有操作都围绕着“规则”进行。您可以添加任意多条规则，系统会智能地处理它们。主要有三种规则类型：

1.  **包含 (Include):** 提取匹配此标签的内容。
2.  **排除 (Exclude):** 从文本中**预先移除**匹配此标签的内容。
3.  **正则包含 (Regex Include):** 使用正则表达式进行高级提取。系统会提取正则表达式中第一个**捕获组 `(...)`** 匹配到的内容。

## 处理顺序 (重要！)

系统严格遵循一个固定的、健壮的处理流程，与您在UI中设置的规则顺序无关：

1.  **全局排除:** 首先，应用所有“排除”规则，从原始文本中移除所有不想要的内容。
2.  **全局提取:** 然后，在“净化后”的文本上，应用所有“包含”和“正则包含”规则来提取您需要的内容。
    *   **注意:** 如果您没有设置任何“包含”或“正则包含”规则，系统将默认提取所有经过排除步骤后剩余的全部文本。
3.  **黑名单过滤:** 最后，对提取出的内容进行黑名单检查。

---

## 用法示例

以下是常见配置如何用新系统实现：

### 场景1: 提取简单标签

**目标:** 提取 `<content>` 和 `<thinking>` 标签的内容。

**操作方法:** 添加 **两条** `包含` 规则。

1.   **规则一:** 类型: `包含`, 值: `content`
2.   **规则二:** 类型: `包含`, 值: `thinking`

### 场景2: 提取复杂条件内容

**目标:** 只提取 `<summary>` 为“摘要”的 `<details>` 块中的内容。

**操作方法:** 添加 **一条** `正则包含` 规则。

-   **类型:** `正则包含`
-   **值:** <code>&lt;details&gt;&lt;summary&gt;摘要&lt;/summary&gt;([\s\S]*?)&lt;/details&gt;</code>

*(原理: 正则表达式会匹配整个结构，但系统只提取由圆括号 `(...)` 捕获的内容。)*

### 场景3: 嵌套排除

**目标:** 提取 `<content>` 的内容，但**不包括**其中的 `<thinking>` 和 `<analysis>` 部分。

**操作方法:** 添加 **三条** 规则。

1.   **规则一 (排除):** 类型: `排除`, 值: `thinking`
2.   **规则二 (排除):** 类型: `排除`, 值: `analysis`
3.   **规则三 (提取):** 类型: `包含`, 值: `content`

*(工作流程: 系统会先从原始文本中移除所有 `<thinking>` 和 `<analysis>` 块，然后在剩下的“干净”文本中提取 `<content>` 的内容。)*

### 场景4: 复杂提取与排除结合

**目标:** 提取 `<summary>` 为“摘要”的 `<details>` 块，但排除其中的 `<note>` 和 `<思考>` 部分。

**操作方法:** 添加 **三条** 规则。

1.   **规则一 (排除):** 类型: `排除`, 值: `note`
2.   **规则二 (排除):** 类型: `排除`, 值: `思考`
3.   **规则三 (提取):** 类型: `正则包含`, 值: <code>&lt;details&gt;&lt;summary&gt;摘要&lt;/summary&gt;([\s\S]*?)&lt;/details&gt;</code>

### 场景5: 掉格式解决办法

**问题描述:** AI返回的消息前面有一些杂乱内容或格式问题，导致向量化效果不佳。

**目标:** 删除特定标签之前的所有内容，只保留从该标签开始的部分。

**操作方法:** 添加 **一条** `正则排除` 规则。

#### 示例1: 删除 `<content>` 标签之前的所有内容

-   **类型:** `正则排除`
-   **值:** <code>^[\s\S]*?(?=&lt;content&gt;)</code>

*(效果: 删除从文本开头到 `<content>` 标签之前的所有内容，保留标签本身及其后面的内容)*

#### 示例2: 删除包括标签在内的所有前置内容

-   **类型:** `正则排除`
-   **值:** <code>^[\s\S]*?&lt;content&gt;</code>

*(效果: 删除从文本开头到 `<content>` 标签（含标签本身）的所有内容)*

#### 示例3: 删除到特定文本之前

**假设AI消息格式如下:**

一些无关的前置内容...
更多杂乱信息...
=== 正式回答 ===
这是实际需要的内容


-   **类型:** `正则排除`
-   **值:** <code>^[\s\S]*?(?=== 正式回答 ===)</code>

*(效果: 删除 "=== 正式回答 ===" 之前的所有内容)*

#### 正则表达式解释

- `^` - 匹配文本开始
- `[\s\S]*?` - 匹配任意字符（包括换行），非贪婪模式
- `(?=<标签>)` - 正向前瞻，匹配到标签位置但不包含标签本身
- 如果要包含标签本身也被删除，去掉 `(?=...)` 包装即可

### 场景6: 小CoT（内思考）示例

**问题描述:** AI消息中包含HTML注释格式的思考过程（Chain of Thought），这些内容不应该被向量化。

**示例内容:**
```
<!-- consider: (角色对白模拟插入) -->
<!--
模拟对白1 (冷静克制): "喂……你们……也看看我这边啊……"
模拟对白2 (失控渴望): "……我……也要……"
-->
她没有说话。

她只是摇摇晃晃地，从沙发上站了起来。高跟鞋掉了一只，她也毫不在意，就那样光着一只脚，踩在黏腻的地板上。
```

**目标:** 排除HTML注释中的内思考内容，只保留实际的叙述文本。

**操作方法:** 添加 **一条** `正则排除` 规则。

-   **类型:** `正则排除`
-   **值:** `<!--[\s\S]*?-->`

*(效果: 删除所有HTML注释块，包括其中的多行内容)*

**其他方法:** 也可以使用UI中的"去除小CoT"按钮，一键添加此规则。

---

## 注意事项

1.  **顺序无关:** 您在UI中添加规则的顺序**不影响**执行结果。系统总是遵循"先排除，后提取"的原则。
2.  **捕获组是关键:** 对于 `正则包含` 规则，请确保您想要提取的部分被包裹在**第一个圆括号捕获组 `(...)`** 中。
3.  **内容保留:** 提取的内容会保留其内部的HTML标签结构。
4.  **黑名单:** 黑名单过滤总是在所有标签提取/排除操作**之后**进行。
5.  **正则排除的强大功能:** `正则排除` 规则可以用于清理格式问题，特别是删除特定位置之前的内容。
